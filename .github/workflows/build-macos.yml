name: macOS Darkplaces Builds

on:
  push:
    branches:
     - master
  pull_request:

jobs:
  darkplaces-arm64:
    runs-on: macos-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Install Homebrew dependencies
      run: |
        brew update
        brew install \
          sdl2 \
          libpng \
          jpeg \
          zlib \
          pkg-config \
          cmake \
          automake \
          autoconf

    - name: Build Darkplaces (ARM64)
      run: |
        export CPPFLAGS="-I/opt/homebrew/opt/jpeg/include -I/opt/homebrew/opt/zlib/include"
        export LDFLAGS="-L/opt/homebrew/opt/jpeg/lib -L/opt/homebrew/opt/zlib/lib"
        export PKG_CONFIG_PATH="/opt/homebrew/opt/jpeg/lib/pkgconfig:/opt/homebrew/opt/zlib/lib/pkgconfig"
        arch -arm64 make -j$(sysctl -n hw.ncpu) sdl-release

    - name: List build outputs
      run: ls -lh .    

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: darkplaces-sdl
        path: ./darkplaces-sdl
